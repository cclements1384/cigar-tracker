@page "/upc-lookup"
@rendermode InteractiveServer
@using cigar_tracker.Models
@using cigar_tracker.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject UpcService UpcService

<PageTitle>UPC Lookup - Cigar Tracker</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1>üì¶ UPC Product Lookup</h1>
            <p class="text-muted">Enter a UPC code to look up product information</p>

            <div class="card">
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input 
                            type="text" 
                            class="form-control form-control-lg" 
                            placeholder="Enter UPC code..." 
                            @bind="upcInput"
                            @onkeyup="HandleKeyPress"
                            id="upcInput"
                        />
                        <button 
                            class="btn btn-primary btn-lg" 
                            type="button"
                            @onclick="LookupUpc"
                            disabled="@isLoading"
                        >
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Searching...</span>
                            }
                            else
                            {
                                <span>üîç Search</span>
                            }
                        </button>
                    </div>
                </div>
            </div>

            @if (product != null)
            {
                <div class="card mt-4">
                    <div class="card-body">
                        @if (product.Found)
                        {
                            <div class="row">
                                @if (!string.IsNullOrEmpty(product.ImageUrl))
                                {
                                    <div class="col-md-4 text-center mb-3">
                                        <img src="@product.ImageUrl" alt="@product.Title" class="img-fluid rounded" style="max-width: 300px;" />
                                    </div>
                                }
                                <div class="col-md-8">
                                    <h3>@product.Title</h3>
                                    
                                    @if (!string.IsNullOrEmpty(product.Brand))
                                    {
                                        <p><strong>Brand:</strong> @product.Brand</p>
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(product.Description))
                                    {
                                        <p><strong>Description:</strong> @product.Description</p>
                                    }
                                    
                                    <p><strong>UPC:</strong> <code>@product.Upc</code></p>
                                    
                                    @if (product.Price.HasValue)
                                    {
                                        <p><strong>Price:</strong> <span class="badge bg-success">${product.Price:F2}</span></p>
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(product.Retailer))
                                    {
                                        <p><strong>Retailer:</strong> @product.Retailer</p>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning" role="alert">
                                <h4 class="alert-heading">Product Not Found</h4>
                                <p>No product found for UPC: <code>@product.Upc</code></p>
                                <p class="mb-0">Try a different UPC or check that the code is valid.</p>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (showError)
            {
                <div class="alert alert-danger mt-4" role="alert">
                    <h4 class="alert-heading">Error</h4>
                    <p>@errorMessage</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string upcInput = string.Empty;
    private UpcProduct? product = null;
    private bool isLoading = false;
    private bool showError = false;
    private string errorMessage = string.Empty;

    private async Task LookupUpc()
    {
        if (string.IsNullOrWhiteSpace(upcInput))
        {
            showError = true;
            errorMessage = "Please enter a UPC code.";
            return;
        }

        isLoading = true;
        showError = false;
        errorMessage = string.Empty;

        try
        {
            product = await UpcService.LookupUpcAsync(upcInput);
        }
        catch (Exception ex)
        {
            showError = true;
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LookupUpc();
        }
    }
}
